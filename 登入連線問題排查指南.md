# 登入時「無法連接到伺服器」問題排查指南

## 📋 問題描述
登入時出現錯誤訊息：
> **無法連接伺服器，請檢查網路連線或稍後再試**

---

## 🔍 根本原因分析

### 問題已修復 ✅
之前 `login.js` 中的 API URL 檢查邏輯與 `config.js` 中的 URL 不匹配，導致即使 API_URL 已正確設置，系統仍認為未設置。

### 改進項目
1. ✅ 修正 API URL 驗證邏輯（更靈活的檢查方式）
2. ✅ 改進 JSONP 請求的日誌記錄
3. ✅ 提供更詳細的錯誤信息提示

---

## 🛠️ 快速診斷步驟

### 步驟 1️⃣: 檢查 config.js 設置

打開 [config.js](config.js)，確認：

```javascript
// ✅ 應該看起來像這樣（不是空的或 YOUR_API_URL_HERE）
API_URL: 'https://script.google.com/macros/s/AKfycbwWv5sGD8YF5gGHJPyVmQqFMnkZwOTVMKgH_-z_J1ykYMAssApwtyx1iM8tNlyv47VIUQ/exec',

// ✅ Google Client ID 也應該設置
GOOGLE_CLIENT_ID: '217213057326-blui949ga463mltkv66m7d5fgbi03fll.apps.googleusercontent.com',
```

**❌ 如果看到這些，說明配置不正確：**
```javascript
API_URL: 'YOUR_API_URL_HERE',
GOOGLE_CLIENT_ID: 'YOUR_CLIENT_ID_HERE.apps.googleusercontent.com',
```

### 步驟 2️⃣: 開啟開發者工具檢查日誌

1. 開啟登入頁面 (login.html)
2. 按 **F12** 打開開發者工具
3. 切換到 **Console** 標籤
4. 嘗試登入並查看訊息

**✅ 正常的日誌會像這樣：**
```
✅ 登入頁面載入完成！
📋 API 網址: https://script.google.com/macros/s/AKfycbwWv5sGD8YF5gGHJPyVmQqFMnkZwOTVMKgH_-z_J1ykYMAssApwtyx1iM8tNlyv47VIUQ/exec
🔑 Client ID: 217213057326-blui949ga463mltkv66m7d5fgbi03fll.apps.googleusercontent.com
🔍 檢查 Google API...
✅ Google API 載入成功！
✅ Google 登入按鈕已成功初始化並渲染
🔐 Google 登入成功！
👤 使用者資料: {...}
📤 正在送出使用者資料到後端...
🔗 發送請求到: https://script.google.com/macros/s/AKfycbwWv5sGD8YF5gGHJPyVmQqFMnkZwOTVMKgH_-z_J1ykYMAssApwtyx1iM8tNlyv47VIUQ/exec?...
```

**❌ 問題警告會像這樣：**
```
⚠️ 尚未設定後端 API 網址
❌ 無法連接伺服器
⏱️ JSONP 請求超時（15秒）
```

### 步驟 3️⃣: 驗證 Google Apps Script 部署

1. 打開 Google Sheets（使用的教學資料表）
2. 進入 **擴充功能** → **Apps Script**
3. 確認部署狀態：
   - 點選 **部署** 按鈕
   - 選擇 **管理部署作業**
   - 確保有 **「最新版本」** 的部署且狀態為 **✅ 啟用**

**部署網址應該與 config.js 中的 API_URL 完全相同**

---

## 📊 常見問題及解決方案

### 問題 1: API_URL 為空或未設置

**症狀：**
```
⚠️ 尚未設定後端 API 網址
❌ 後端 API 尚未正確設定，請檢查 config.js
```

**解決方案：**
1. 打開 [config.js](config.js)
2. 找到第 32 行的 `API_URL`
3. 確認它不是空的或預設值
4. 應該是這樣的格式：`https://script.google.com/macros/s/AKfycb...../exec`

### 問題 2: API_URL 與 Google Apps Script 部署不匹配

**症狀：**
```
⏱️ JSONP 請求超時（15秒）
❌ 伺服器無回應，請檢查 API_URL 是否正確部署
```

**解決方案：**
1. 前往 Google Sheets
2. **擴充功能** → **Apps Script** → **編輯器**
3. 找到 `doGet()` 函數，確保 `action` 參數包含 `'login'`
4. 點選 **部署** → **新部署**
5. 選擇 **類型** = Web 應用程式
6. **執行身份** = 自己的帳號
7. **誰可以存取** = 任何人
8. 複製新的部署網址到 [config.js](config.js)

### 問題 3: Google OAuth Client ID 無效

**症狀：**
```
Google 登入初始化失敗
Google 登入服務載入失敗
```

**解決方案：**
1. 前往 [Google Cloud Console](https://console.cloud.google.com)
2. 選擇正確的專案
3. **API 和服務** → **憑證**
4. 確認有 **OAuth 2.0 用戶端 ID**（類型：Web 應用程式）
5. 確認授權的重新導向 URI 包含：`http://localhost:3000/login.html`（或實際部署的網址）
6. 複製 Client ID 到 [config.js](config.js) 的 `GOOGLE_CLIENT_ID`

### 問題 4: 瀏覽器阻止跨域請求 (CORS)

**症狀：**
```
❌ JSONP 載入失敗 - 請檢查 API URL 是否正確
```

**控制台會看到：**
```
Access to script at 'https://script.google.com/...' from origin 'http://localhost:3000' 
has been blocked by CORS policy
```

**解決方案：**
- Google Apps Script 預設支持 CORS
- 確保 Google Apps Script 部署為 **Web 應用程式**（不是 API 可執行檔）
- 檢查 `doGet()` 中是否有正確的回應頭設置

### 問題 5: 測試模式啟用

**症狀：**
```
🧪 測試模式：模擬登入成功
```

**說明：**
如果看到這訊息，表示系統在測試模式下運行，會跳過真實的伺服器連線。

**關閉測試模式：**
1. 打開 [config.js](config.js)
2. 找到 `TEST_MODE: true`
3. 改為 `TEST_MODE: false`

---

## 🧪 測試連線

### 方法 1: 檢查 API 是否可訪問

在瀏覽器網址列複製貼上 API_URL（去掉 `?` 之後的部分），應該看到 Google Apps Script 的回應。

### 方法 2: 使用開發者工具測試

在 Console 中執行：

```javascript
// 測試 API 連線
const testUrl = APP_CONFIG.API_URL + '?action=test';
console.log('測試 URL:', testUrl);

fetch(testUrl)
    .then(res => res.text())
    .then(data => console.log('✅ 連線成功:', data))
    .catch(err => console.error('❌ 連線失敗:', err));
```

---

## 📞 如果仍然無法解決

### 需要提供的資訊：
1. 完整的控制台錯誤訊息（開發者工具 > Console）
2. config.js 中的 API_URL（可隱藏部分敏感資訊）
3. 部署的網址
4. 使用的瀏覽器和版本

### 快速檢查清單：
- [ ] ✅ API_URL 已設置且不為空
- [ ] ✅ API_URL 與 Google Apps Script 部署網址一致
- [ ] ✅ Google Apps Script 已正確部署為 Web 應用程式
- [ ] ✅ Google OAuth Client ID 已正確設置
- [ ] ✅ 瀏覽器網路連線正常
- [ ] ✅ TEST_MODE 已改為 false（如果想要真實登入）

---

## 📝 修復紀錄

**2024年12月 - 本次修正：**
- ✅ 修正 login.js 中的 API URL 檢查邏輯
- ✅ 改進 JSONP 請求的錯誤處理
- ✅ 添加更詳細的日誌和診斷資訊

**改進內容：**
1. API URL 驗證現在更加靈活（不依賴硬編碼的舊 URL）
2. 提供更清晰的错誤提示
3. 日誌記錄更詳細，便於除錯

---

## 🎯 成功登入的標誌

當看到這些訊息時，表示登入成功：
```
✅ 後端回應: {success: true, user_id: "...", role: "..."}
✅ 學生綁定成功！
✅ 老師登入成功！
```

並會自動重新導向到對應的首頁（teacher.html 或 student.html）。
