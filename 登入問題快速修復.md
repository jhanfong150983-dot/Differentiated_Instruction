# ⚡ 登入連線問題 - 快速修復清單

## 🎯 原因總結

你看到的「**無法連接伺服器**」錯誤通常來自以下幾個原因：

| 優先級 | 原因 | 症狀 | 解決方案 |
|-------|------|------|--------|
| 🔴 **最高** | API_URL 未正確設置 | 頁面加載時就提示「API 尚未設定」 | ✅ 見下方步驟 1 |
| 🟠 **高** | API_URL 與部署網址不匹配 | 登入後卡住 15 秒然後超時 | ✅ 見下方步驟 2 |
| 🟡 **中** | Google Apps Script 部署失敗 | JSONP 請求失敗 | ✅ 見下方步驟 3 |
| 🟢 **低** | 網路連接問題 | 間歇性失敗 | ✅ 見下方步驟 4 |

---

## ✅ 5 分鐘快速修復

### 步驟 1️⃣: 檢查並更新 API_URL

**打開文件：** [config.js](config.js)

**尋找這一行（大約第 32 行）：**
```javascript
API_URL: 'https://script.google.com/macros/s/..../exec',
```

**確認：**
- [ ] 不是空的
- [ ] 不是 `YOUR_API_URL_HERE`
- [ ] 是完整的 Google Apps Script 部署 URL

**如果不確定，請執行步驟 2**

---

### 步驟 2️⃣: 獲取正確的 Google Apps Script 部署 URL

1. **打開 Google Sheets**（你的教學資料表）

2. **進入 Apps Script：**
   - 點選菜單 **擴充功能** → **Apps Script**

3. **檢查是否已部署：**
   - 左側菜單找到 **部署** 按鈕
   - 點選 **管理部署作業**

4. **確認部署狀態：**
   - 應該看到一個 **「最新版本」** 的部署
   - 狀態應該是 ✅ **已啟用**
   - 複製這個部署的 **網址**

5. **更新 config.js：**
   ```javascript
   API_URL: '複製來的網址'  // 粘貼這裡
   ```

6. **保存並重新加載頁面**

---

### 步驟 3️⃣: 重新部署（如果不確定）

如果不確定部署是否成功，重新部署一次：

1. **在 Google Apps Script 編輯器中：**
   - 點選 **部署** 按鈕（右上角）
   - 選擇 **新部署**

2. **配置部署：**
   ```
   類型：選擇「Web 應用程式」
   執行身份：選擇「自己的帳號」
   誰可以存取：選擇「任何人」
   ```

3. **複製新 URL 並更新 config.js**

---

### 步驟 4️⃣: 清除瀏覽器快取並測試

1. **清除快取：**
   - 按 **Ctrl + Shift + Delete**（Windows）或 **Cmd + Shift + Delete**（Mac）
   - 選擇時間範圍 **所有時間**
   - 勾選 **快取的圖片和檔案**
   - 點擊 **清除數據**

2. **重新打開登入頁面**

3. **打開開發者工具檢查：**
   - 按 **F12**
   - 進入 **Console** 標籤
   - 查看是否有錯誤訊息

---

### 步驟 5️⃣: 測試登入

嘗試用 Google 帳號登入，檢查：

**✅ 成功的跡象：**
```
✅ 登入頁面載入完成！
✅ Google API 載入成功！
✅ Google 登入按鈕已成功初始化並渲染
🔐 Google 登入成功！
📤 正在送出使用者資料到後端...
✅ 後端回應: {success: true, ...}
```
然後會自動跳轉到首頁 ✨

**❌ 失敗的跡象：**
- `⚠️ 尚未設定後端 API 網址` → 執行步驟 1-2
- `⏱️ JSONP 請求超時（15秒）` → 執行步驟 2-3
- `❌ JSONP 載入失敗` → 執行步驟 3-4

---

## 🔧 進階診斷（如果以上不管用）

### 在瀏覽器 Console 中執行：

```javascript
// 1. 檢查 config.js 是否正確加載
console.log('API_URL:', APP_CONFIG.API_URL);
console.log('Client ID:', APP_CONFIG.GOOGLE_CLIENT_ID);

// 2. 測試 API 連線
const testUrl = APP_CONFIG.API_URL + '?action=ping';
fetch(testUrl)
    .then(r => r.text())
    .then(d => console.log('✅ 伺服器回應:', d))
    .catch(e => console.error('❌ 連線失敗:', e));

// 3. 檢查 Google API
console.log('Google API 已載入:', typeof google !== 'undefined');
```

**預期輸出：**
```javascript
API_URL: "https://script.google.com/macros/s/AKfycb...../exec"
Client ID: "217213057326-blui949ga463mltkv66m7d5fgbi03fll.apps.googleusercontent.com"
✅ 伺服器回應: ...
Google API 已載入: true
```

---

## 📞 常見錯誤信息速查表

| 錯誤信息 | 原因 | 解決方案 |
|---------|------|--------|
| `⚠️ 尚未設定後端 API 網址` | API_URL 未設置或為預設值 | 更新 config.js 的 API_URL |
| `⏱️ JSONP 請求超時（15秒）` | 伺服器無回應 | 檢查 API_URL 是否正確 |
| `❌ JSONP 載入失敗` | 無法載入 API | 重新部署 Google Apps Script |
| `Google 登入服務載入失敗` | Google API 未成功加載 | 重新整理頁面或檢查網路 |
| 自動跳轉但顯示空白頁 | 首頁檔案不存在或路徑錯誤 | 檢查 teacher.html 或 student.html 是否存在 |

---

## 💡 最常見的解決方案

**90% 的「無法連接伺服器」錯誤原因是：**

1. ❌ config.js 中的 API_URL 為空或是舊值
2. ❌ Google Apps Script 未正確部署為 Web 應用程式
3. ❌ API_URL 是舊的部署網址（之前重新部署過）

**快速檢查：**
```javascript
// 在 Console 中執行
console.log('API_URL:', APP_CONFIG.API_URL);
// 如果看到 undefined 或奇怪的值，就是問題所在
```

---

## 📝 本次修復記錄

**修復日期：** 2024年12月

**修復內容：**
1. ✅ 改進 login.js 中的 API URL 驗證邏輯（第 180-196 行）
   - 改為更靈活的檢查方式
   - 不再依賴硬編碼的舊 URL

2. ✅ 改進錯誤提示信息（第 220-237 行）
   - 提供具體的檢查建議
   - 區分不同類型的錯誤

3. ✅ 改進 JSONP 請求的日誌（第 244-294 行）
   - 記錄完整的 API URL
   - 提供更清晰的超時訊息

**結果：**
更容易診斷和解決連線問題 ✨

---

## 🆘 仍需幫助？

如果按照上述步驟仍未解決，請收集並提供：

1. **config.js 中的 API_URL**（可隱藏部分敏感資訊）
   ```javascript
   API_URL: 'https://script.google.com/macros/s/AKfycb............./exec'
                                         ^^^^^^^^此處開始匿名
   ```

2. **瀏覽器 Console 的完整錯誤訊息**（F12 > Console）

3. **Google Apps Script 部署狀態截圖**

4. **使用的瀏覽器類型和版本**

---

**祝登入順利！🎉**
